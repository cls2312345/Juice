<script>
    const SECRET_CODE = "DMSADMIN";
    const BUCKET_URL = "https://pub-e7c0cf4469274deb8a0ac4b35144263b.r2.dev/";
    
    let rawFiles = [];
    const player = document.getElementById('audioPlayer');

    // Emergency manual check - type password and hit Enter
    document.getElementById('passInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            checkPass();
        }
    });

    async function checkPass() {
        const val = document.getElementById('passInput').value.toUpperCase();
        if (val === SECRET_CODE) {
            document.getElementById('gatekeeper').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            await syncVault();
        } else {
            alert("WRONG CODE");
        }
    }

    async function syncVault() {
        try {
            // Using a timeout so it doesn't stay white forever
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            const response = await fetch(BUCKET_URL, { signal: controller.signal });
            const text = await response.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");
            
            const keys = xml.getElementsByTagName("Key");
            rawFiles = [];
            
            for (let i = 0; i < keys.length; i++) {
                let filename = keys[i].textContent;
                if (filename.endsWith(".mp3")) {
                    rawFiles.push(filename);
                }
            }
            
            if(rawFiles.length === 0) {
                document.getElementById('currentTitle').innerText = "NO SONGS FOUND IN BUCKET";
            }
            
            loadList(rawFiles);
        } catch (err) {
            console.error(err);
            document.getElementById('currentTitle').innerText = "SYNC FAILED - CHECK CLOUDFLARE CORS";
        }
    }

    function loadList(files) {
        const listDiv = document.getElementById('list');
        if (!listDiv) return;
        listDiv.innerHTML = files.map((file, index) => `
            <div class="song-item" onclick="playSong('${file}', ${index})">
                ${file.replace('.mp3', '').replaceAll('%20', ' ')}
            </div>
        `).join('');
    }

    function playSong(file, index) {
        player.src = BUCKET_URL + file;
        player.play();
        document.getElementById('currentTitle').innerText = file.replace('.mp3', '');
    }
</script>
